name: MINIX RISC-V 64 Build Test

on:
  push:
    branches: [ master, riscv64 ]
  pull_request:
    branches: [ master, riscv64 ]
  workflow_dispatch:

jobs:
  build-riscv64:
    name: Build MINIX for RISC-V 64
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          bison \
          flex \
          libgmp-dev \
          libmpfr-dev \
          libmpc-dev \
          zlib1g-dev \
          libssl-dev \
          python3 \
          python3-pip \
          texinfo \
          bc \
          wget \
          curl \
          git \
          qemu-system-riscv64 \
          gcc-riscv64-linux-gnu \
          gcc-riscv64-unknown-elf \
          clang \
          lld \

    - name: Cache build artifacts
      uses: actions/cache@v3
      with:
        path: |
          /home/donz/minix/obj
          /home/donz/minix/obj.tooldir.*
          ~/.ccache
        key: ${{ runner.os }}-minix-riscv64-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-minix-riscv64-
          ${{ runner.os }}-minix-

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ runner.os }}-ccache-riscv64
        max-size: 2G

    - name: Check GCC versions
      run: |
        echo "=== System GCC version ==="
        gcc --version
        echo ""
        echo "=== Host RISC-V GCC version ==="
        riscv64-linux-gnu-gcc --version || echo "riscv64-linux-gnu-gcc not found"
        echo ""
        echo "=== Cross RISC-V GCC version ==="
        riscv64-unknown-elf-gcc --version || echo "riscv64-unknown-elf-gcc not found"
        echo ""
        echo "=== Clang version ==="
        clang --version

    - name: Verify RISC-V 64 architecture files
      run: |
        echo "=== Checking RISC-V 64 architecture directories ==="
        ls -la sys/arch/riscv/include/ | head -10
        echo ""
        echo "=== Architecture file count ==="
        echo "sys/arch/riscv/include: $(ls sys/arch/riscv/include/ | wc -l) files"
        echo "minix/kernel/arch/riscv64: $(find minix/kernel/arch/riscv64 -type f | wc -l) files"
        echo "minix/lib/libc/arch/riscv64: $(find minix/lib/libc/arch/riscv64 -type f 2>/dev/null | wc -l) files"

    - name: Configure build environment
      run: |
        echo "=== Setting up build environment ==="
        export TOOLDIR=/tmp/minix-tools
        export DESTDIR=/tmp/minix-root
        export USE_CCACHE=1
        export CCACHE_COMPRESS=1
        export CCACHE_MAXSIZE=2G
        export MKUPDATE=yes
        export MKUNPRIVED=yes
        export HOST_SH=/bin/bash

        # Create directories
        mkdir -p $TOOLDIR
        mkdir -p $DESTDIR

        # Check if evbriscv64 is recognized
        echo "=== Checking architecture recognition ==="
        ./build.sh -m evbriscv64 list-arch || echo "list-arch not available"

    - name: Build tools for RISC-V 64
      run: |
        echo "=== Building tools for RISC-V 64 ==="
        export TOOLDIR=/tmp/minix-tools
        export DESTDIR=/tmp/minix-root
        export USE_CCACHE=1
        export CCACHE_COMPRESS=1
        export MKUPDATE=yes
        export MKUNPRIVED=yes
        export HOST_SH=/bin/bash
        export HOST_CFLAGS="-O -fcommon"
        export HAVE_GOLD=no

        # Build tools with timeout
        timeout 90m ./build.sh -U -m evbriscv64 tools || {
          echo "Tools build failed or timed out after 90 minutes"
          exit 1
        }

    - name: Build MINIX libraries
      run: |
        echo "=== Building MINIX libraries for RISC-V 64 ==="
        export TOOLDIR=/tmp/minix-tools
        export DESTDIR=/tmp/minix-root
        export USE_CCACHE=1
        export CCACHE_COMPRESS=1
        export MKUPDATE=yes
        export MKUNPRIVED=yes
        export HOST_SH=/bin/bash
        export HOST_CFLAGS="-O -fcommon"
        export HAVE_GOLD=no

        # Build libraries
        timeout 60m ./build.sh -U -m evbriscv64 libs || {
          echo "Libraries build failed or timed out after 60 minutes"
          exit 1
        }

    - name: Build kernel
      run: |
        echo "=== Building RISC-V 64 kernel ==="
        export TOOLDIR=/tmp/minix-tools
        export DESTDIR=/tmp/minix-root
        export USE_CCACHE=1
        export CCACHE_COMPRESS=1
        export MKUPDATE=yes
        export MKUNPRIVED=yes
        export HOST_SH=/bin/bash
        export HOST_CFLAGS="-O -fcommon"
        export HAVE_GOLD=no
        export MKPCI=no

        # Build kernel
        cd minix/kernel && \
        timeout 60m make obj && \
        timeout 60m make depend && \
        timeout 60m make || {
          echo "Kernel build failed or timed out"
          exit 1
        }

    - name: Check build output
      run: |
        echo "=== Checking build artifacts ==="
        find /tmp/minix-tools -name "*riscv*" -type f | head -20
        echo ""
        echo "=== Kernel binary ==="
        find . -name "kernel_*" -o -name "kernel.*" | grep riscv || echo "Kernel binary not found"
        echo ""
        echo "=== Tool status ==="
        ls -la /tmp/minix-tools/bin/ | grep -E "(riscv|clang)" | head -10

    - name: Test QEMU basic functionality
      run: |
        echo "=== Testing QEMU RISC-V 64 support ==="
        qemu-system-riscv64 --version
        echo ""
        echo "=== Checking available machines ==="
        qemu-system-riscv64 -M help | grep virt

    - name: Create bootable image
      run: |
        echo "=== Creating bootable image ==="
        if [ -f minix/kernel/kernel ]; then
          mkdir -p /tmp/minix-image
          cp minix/kernel/kernel /tmp/minix-image/
          echo "Kernel copied to image directory"
          ls -la /tmp/minix-image/
        else
          echo "Kernel not found, checking for other kernel files..."
          find . -name "kernel*" -type f | grep -E "\.(elf|bin)$" || echo "No kernel binary found"
        fi

    - name: Run basic tests
      run: |
        echo "=== Running basic RISC-V 64 tests ==="
        if [ -d minix/tests/riscv64 ]; then
          cd minix/tests/riscv64
          if [ -f run_tests.sh ]; then
            chmod +x run_tests.sh
            echo "Running RISC-V 64 specific tests..."
            timeout 10m ./run_tests.sh all || echo "Tests completed with status: $?"
          else
            echo "No run_tests.sh found"
          fi
        else
          echo "RISC-V 64 tests directory not found"
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: minix-riscv64-build-${{ github.run_number }}
        path: |
          /tmp/minix-tools
          /tmp/minix-root
          /tmp/minix-image
          minix/kernel/kernel*
        retention-days: 30

    - name: Build summary
      run: |
        echo "=== Build Summary ==="
        echo "Date: $(date)"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo ""
        echo "=== Build Status ==="
        echo "Tools: $([ -d /tmp/minix-tools/bin ] && echo '✅ Success' || echo '❌ Failed')"
        echo "Kernel: $([ -f minix/kernel/kernel ] && echo '✅ Success' || echo '❌ Failed')"
        echo ""
        echo "=== Disk Usage ==="
        df -h
        echo ""
        echo "=== Build Cache Stats ==="
        ccache -s || echo "ccache not available"