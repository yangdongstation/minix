name: MINIX RISC-V 64 Quick Check

on:
  push:
    branches: [ master, riscv64 ]
  pull_request:
    branches: [ master, riscv64 ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

jobs:
  quick-check:
    name: Quick RISC-V 64 Build Check
    runs-on: ubuntu-20.04  # Use Ubuntu 20.04 for better GCC compatibility

    strategy:
      fail-fast: false
      matrix:
        check_type: [tools-quick, libs-quick, kernel-quick]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          bison \
          flex \
          libgmp-dev \
          libmpfr-dev \
          libmpc-dev \
          zlib1g-dev \
          python3 \
          texinfo \
          bc \
          wget \
          qemu-system-riscv64 \
          gcc-riscv64-linux-gnu \
          gcc

    - name: Check GCC version compatibility
      run: |
        echo "=== System GCC ==="
        gcc --version | head -1
        echo ""
        echo "=== Checking MINIX GCC requirements ==="
        grep -r "HAVE_GCC" share/mk/bsd.own.mk | grep "=" || echo "HAVE_GCC not found"
        echo ""
        echo "NetBSD uses GCC 4.8 for MINIX compatibility"

    - name: Verify RISC-V 64 files
      run: |
        echo "=== Architecture files check ==="

        # Check critical directories exist
        [ -d sys/arch/riscv ] && echo "✅ sys/arch/riscv exists" || echo "❌ sys/arch/riscv missing"
        [ -d minix/kernel/arch/riscv64 ] && echo "✅ minix/kernel/arch/riscv64 exists" || echo "❌ minix/kernel/arch/riscv64 missing"

        # Check critical header files
        critical_headers=(
          "sys/arch/riscv/include/limits.h"
          "sys/arch/riscv/include/signal.h"
          "sys/arch/riscv/include/types.h"
          "sys/arch/riscv/include/unistd.h"
          "sys/arch/riscv/include/machine/asm.h"
        )

        for header in "${critical_headers[@]}"; do
          if [ -f "$header" ]; then
            echo "✅ $header"
          else
            echo "❌ $header missing"
          fi
        done

    - name: Quick tools build check (${{ matrix.check_type }})
      run: |
        set -e
        echo "=== Starting ${{ matrix.check_type }} ==="

        export TOOLDIR=/tmp/minix-tools-${{ matrix.check_type }}
        export DESTDIR=/tmp/minix-root-${{ matrix.check_type }}
        export HOST_CFLAGS="-O -fcommon"
        export HAVE_GOLD=no
        export MKUPDATE=yes
        export HOST_SH=/bin/bash

        case "${{ matrix.check_type }}" in
          tools-quick)
            echo "Building tools (with timeout)..."
            timeout 120m ./build.sh -U -m evbriscv64 tools 2>&1 | tee build-tools.log
            ;;
          libs-quick)
            echo "Building libraries (with timeout)..."
            # Assume tools are already built
            timeout 60m ./build.sh -U -m evbriscv64 libs 2>&1 | tee build-libs.log
            ;;
          kernel-quick)
            echo "Building kernel (with timeout)..."
            cd minix/kernel
            export TOOLDIR=/tmp/minix-tools-quick
            export DESTDIR=/tmp/minix-root-quick
            timeout 60m make -j$(nproc) 2>&1 | tee build-kernel.log
            ;;
        esac

    - name: Check build results
      if: always()
      run: |
        echo "=== Build Results for ${{ matrix.check_type }} ==="

        case "${{ matrix.check_type }}" in
          tools-quick)
            if [ -d /tmp/minix-tools-tools-quick/bin ]; then
              echo "✅ Tools built successfully"
              ls -la /tmp/minix-tools-tools-quick/bin/ | head -10
            else
              echo "❌ Tools build failed"
              tail -100 build-tools.log
            fi
            ;;
          libs-quick)
            if [ -d /tmp/minix-root-quick/usr/lib ]; then
              echo "✅ Libraries built successfully"
              find /tmp/minix-root-quick/usr/lib -name "*.a" | wc -l
            else
              echo "❌ Libraries build failed"
              tail -100 build-libs.log
            fi
            ;;
          kernel-quick)
            if [ -f minix/kernel/kernel ]; then
              echo "✅ Kernel built successfully"
              file minix/kernel/kernel
              ls -la minix/kernel/kernel
            else
              echo "❌ Kernel build failed"
              tail -100 build-kernel.log
            fi
            ;;
        esac

    - name: Upload logs
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: build-logs-${{ matrix.check_type }}-${{ github.run_number }}
        path: |
          build-*.log
          /tmp/minix-*/