# MINIX Kernel Configuration System

## Overview

The `sys/conf/` directory contains the kernel configuration system for MINIX 3, providing the essential framework for configuring, building, and managing kernel parameters, system options, and build-time configuration choices. This directory serves as the central configuration hub that enables customization of MINIX kernel features while maintaining system stability and compatibility across different hardware platforms and use cases.

## Purpose and Responsibilities

### Core Functions
- **Kernel Configuration Management**: Manages kernel build-time configuration options
- **Version Control**: Handles kernel version information and release management
- **Build System Integration**: Integrates with the MINIX build system for automated configuration
- **System Parameter Definition**: Defines system-wide parameters and limits
- **Copyright Management**: Manages system-wide copyright information

### Key Features
- **Automated Configuration** - Script-based configuration generation
- **Version Management** - Automatic version and release information
- **Cross-Platform Support** - Platform-agnostic configuration system
- **Build Integration** - Seamless integration with MINIX build process
- **Copyright Compliance** - Systematic copyright information management

## Directory Structure

```
sys/conf/
├── Makefile               # Main configuration makefile
├── copyright              # System copyright information
├── newvers_stand.sh       # Standalone version generation script
└── osrelease.sh          # OS release information script
```

## Configuration Scripts

### OS Release Information Script (`osrelease.sh`)
The primary configuration script that generates OS release and version information:

```bash
#!/bin/sh
#
# Generate OS release information for MINIX
#

# Default values
OSRELEASE="3.0.0"
OSVERSION="3.0"
OSMAJOR="3"
OSMINOR="0"
OSPATCH="0"

# Parse command line arguments
while [ $# -gt 0 ]; do
    case "$1" in
    -r|--release)
        OSRELEASE="$2"
        shift; shift
        ;;
    -v|--version)
        OSVERSION="$2"
        shift; shift
        ;;
    -h|--help)
        echo "Usage: $0 [-r release] [-v version]"
        echo "Generate OS release information for MINIX"
        exit 0
        ;;
    *)
        echo "Unknown option: $1"
        exit 1
        ;;
    esac
done

# Generate version header
cat << EOF
/*
 * This file is automatically generated - do not edit
 * Generated by: $0
 * Date: $(date)
 */

#ifndef _SYS_CONF_OSRELEASE_H_
#define _SYS_CONF_OSRELEASE_H_

#define OSRELEASE	"$OSRELEASE"
#define OSVERSION	"$OSVERSION"
#define OSMAJOR		$OSMAJOR
#define OSMINOR		$OSMINOR
#define OSPATCH		$OSPATCH

#define OSRELMAJOR	$OSMAJOR
#define OSRELMINOR	$OSMINOR
#define OSRELPATCH	$OSPATCH

#endif /* _SYS_CONF_OSRELEASE_H_ */
EOF
```

### Standalone Version Generation (`newvers_stand.sh`)
Generates version information for standalone boot components:

```bash
#!/bin/sh
#
# Generate version information for standalone boot components
#

# Default configuration
VERSION="3.0"
RELEASE="3.0.0"
MACHINE="generic"
MACHINE_ARCH="unknown"
USER="build"
HOST="buildhost"

# Parse command line arguments
while [ $# -gt 0 ]; do
    case "$1" in
    -v|--version)
        VERSION="$2"
        shift; shift
        ;;
    -r|--release)
        RELEASE="$2"
        shift; shift
        ;;
    -m|--machine)
        MACHINE="$2"
        shift; shift
        ;;
    -a|--arch)
        MACHINE_ARCH="$2"
        shift; shift
        ;;
    -u|--user)
        USER="$2"
        shift; shift
        ;;
    -h|--host)
        HOST="$2"
        shift; shift
        ;;
    *)
        echo "Unknown option: $1"
        exit 1
        ;;
    esac
done

# Generate version information
cat << EOF
/*
 * Standalone boot version information
 * Automatically generated by $0
 * Date: $(date)
 * User: $USER
 * Host: $HOST
 */

#include <sys/types.h>

const char boot_version[] = "MINIX $RELEASE ($MACHINE/$MACHINE_ARCH)";
const char boot_compile[] = "Compiled by $USER@$HOST on $(date)";
const char boot_machine[] = "$MACHINE";
const char boot_arch[] = "$MACHINE_ARCH";
const char boot_release[] = "$RELEASE";
const char boot_version_short[] = "$VERSION";
EOF
```

### Copyright Information (`copyright`)
System-wide copyright information file:

```
# MINIX System Copyright Information
#
# This file contains copyright information for the MINIX system
#

# Copyright holders
COPYRIGHT_HOLDERS="The MINIX 3 Project Contributors"
COPYRIGHT_YEARS="2008-2024"
COPYRIGHT_NOTICE="Copyright (c) $COPYRIGHT_YEARS $COPYRIGHT_HOLDERS"

# License information
LICENSE_TYPE="BSD"
LICENSE_VERSION="3-clause"
LICENSE_URL="https://opensource.org/licenses/BSD-3-Clause"

# System attribution
SYSTEM_NAME="MINIX 3"
SYSTEM_DESCRIPTION="A free, open-source, microkernel-based operating system"
SYSTEM_HOMEPAGE="https://www.minix3.org/"

# Build information
BUILD_DATE="$(date)"
BUILD_SYSTEM="$(uname -s)"
BUILD_ARCHITECTURE="$(uname -m)"
```

## Configuration System Integration

### Build System Integration
The configuration system integrates with the MINIX build process:

```makefile
# sys/conf/Makefile
# Main configuration makefile

# Configuration targets
all: osrelease.h version.h copyright.h

# OS release header
csrelease.h: osrelease.sh
	sh ${.CURDIR}/osrelease.sh -r ${OSRELEASE} -v ${OSVERSION} > ${.TARGET}

# Version header for standalone components
version.h: newvers_stand.sh
	sh ${.CURDIR}/newvers_stand.sh \
		-v ${VERSION} \
		-r ${RELEASE} \
		-m ${MACHINE} \
		-a ${MACHINE_ARCH} \
		-u ${USER} \
		-h ${HOSTNAME} > ${.TARGET}

# Copyright header
copyright.h: copyright
	awk -f ${.CURDIR}/make_copyright.awk ${.CURDIR}/copyright > ${.TARGET}

# Installation
install: osrelease.h version.h copyright.h
	install -m 444 osrelease.h ${DESTDIR}/usr/include/sys/
	install -m 444 version.h ${DESTDIR}/usr/include/sys/
	install -m 444 copyright.h ${DESTDIR}/usr/include/sys/
```

### Cross-Platform Configuration
Supports configuration across different platforms and architectures:

```makefile
# Architecture-specific configuration
.if ${MACHINE_ARCH} == "evbriscv64"
OSRELEASE = "3.0.0-riscv64"
OSVERSION = "3.0-riscv64"
.elif ${MACHINE_ARCH} == "i386"
OSRELEASE = "3.0.0-i386"
OSVERSION = "3.0-i386"
.elif ${MACHINE_ARCH} == "arm"
OSRELEASE = "3.0.0-arm"
OSVERSION = "3.0-arm"
.endif

# Platform-specific configuration
.if ${MACHINE} == "evbriscv64"
PLATFORM_FEATURES = "riscv64 qemu-virt sbi plic"
.elif ${MACHINE} == "i386"
PLATFORM_FEATURES = "i386 pc bios smp"
.elif ${MACHINE} == "evbarm"
PLATFORM_FEATURES = "arm embedded eval-board"
.endif
```

## Generated Configuration Headers

### OS Release Header
Automatically generated OS release information:

```c
/*
 * This file is automatically generated - do not edit
 * Generated by: ./osrelease.sh
 * Date: Mon Jan 1 12:00:00 UTC 2024
 */

#ifndef _SYS_CONF_OSRELEASE_H_
#define _SYS_CONF_OSRELEASE_H_

#define OSRELEASE	"3.0.0"
#define OSVERSION	"3.0"
#define OSMAJOR		3
#define OSMINOR		0
#define OSPATCH		0

#define OSRELMAJOR	3
#define OSRELMINOR	0
#define OSRELPATCH	0

#endif /* _SYS_CONF_OSRELEASE_H_ */
```

### Version Header for Standalone Components
Version information for boot and standalone components:

```c
/*
 * Standalone boot version information
 * Automatically generated by ./newvers_stand.sh
 * Date: Mon Jan 1 12:00:00 UTC 2024
 * User: build
 * Host: buildhost
 */

#include <sys/types.h>

const char boot_version[] = "MINIX 3.0.0 (evbriscv64/riscv64)";
const char boot_compile[] = "Compiled by build@buildhost on Mon Jan 1 12:00:00 UTC 2024";
const char boot_machine[] = "evbriscv64";
const char boot_arch[] = "riscv64";
const char boot_release[] = "3.0.0";
const char boot_version_short[] = "3.0";
```

### Copyright Header
System-wide copyright information:

```c
/*
 * MINIX System Copyright Information
 * Copyright (c) 2008-2024 The MINIX 3 Project Contributors
 *
 * This file is automatically generated - do not edit
 */

#ifndef _SYS_CONF_COPYRIGHT_H_
#define _SYS_CONF_COPYRIGHT_H_

#define COPYRIGHT_HOLDERS "The MINIX 3 Project Contributors"
#define COPYRIGHT_YEARS "2008-2024"
#define COPYRIGHT_NOTICE "Copyright (c) 2008-2024 The MINIX 3 Project Contributors"

#define LICENSE_TYPE "BSD"
#define LICENSE_VERSION "3-clause"
#define LICENSE_URL "https://opensource.org/licenses/BSD-3-Clause"

#define SYSTEM_NAME "MINIX 3"
#define SYSTEM_DESCRIPTION "A free, open-source, microkernel-based operating system"
#define SYSTEM_HOMEPAGE "https://www.minix3.org/"

#define BUILD_DATE "Mon Jan 1 12:00:00 UTC 2024"
#define BUILD_SYSTEM "Linux"
#define BUILD_ARCHITECTURE "x86_64"

#endif /* _SYS_CONF_COPYRIGHT_H_ */
```

## Configuration Parameters

### System Configuration Parameters
Key system parameters managed by the configuration system:

```c
/* System configuration parameters */
#define MAXUSERS        32      /* Maximum number of users */
#define MAXGROUPS       32      /* Maximum number of groups */
#define MAXPROCESSES    256     /* Maximum number of processes */
#define MAXFILES        1024    /* Maximum number of open files */
#define MAXSOCKETS      256     /* Maximum number of sockets */

/* Memory configuration */
#define MAXPHYS         (64 * 1024)     /* Maximum physical I/O size */
#define MAXDUMPPGS      16              /* Maximum dump pages */
#define DFLDSIZ         (16 * 1024 * 1024)      /* Default data size */
#define MAXDSIZ         (512 * 1024 * 1024)     /* Maximum data size */
#define DFLSSIZ         (1 * 1024 * 1024)       /* Default stack size */
#define MAXSSIZ         (32 * 1024 * 1024)      /* Maximum stack size */
```

### Architecture-Specific Configuration
Architecture-specific parameters:

```c
/* Architecture-specific configuration */
#ifdef __riscv64__
#define PAGE_SHIFT      12      /* RISC-V page shift */
#define PAGE_SIZE       (1UL << PAGE_SHIFT)
#define MAXADDR         (1UL << 56)     /* 56-bit address space */
#endif

#ifdef __i386__
#define PAGE_SHIFT      12      /* x86 page shift */
#define PAGE_SIZE       (1UL << PAGE_SHIFT)
#define MAXADDR         0xFFFFFFFF      /* 4GB address space */
#endif

#ifdef __arm__
#define PAGE_SHIFT      12      /* ARM page shift */
#define PAGE_SIZE       (1UL << PAGE_SHIFT)
#define MAXADDR         0xFFFFFFFF      /* 4GB address space */
#endif
```

## Build Integration

### Configuration in Build Process
The configuration system integrates with the overall MINIX build process:

```bash
#!/bin/sh
# Integration with main build system

# Generate configuration headers
cd sys/conf
make clean
make all
make install

# Configuration is now available for kernel build
cd ../..
make includes  # Includes generated configuration headers
make kernel    # Uses configuration headers
```

### Dependency Management
Configuration dependencies ensure proper build ordering:

```makefile
# Configuration dependencies
kernel: config
config: sys/conf/all

sys/conf/all:
	${MAKE} -C sys/conf

# Architecture dependencies
sys/arch/${MACHINE_ARCH}/include/sys/param.h: sys/conf/osrelease.h
	${MAKE} -C sys/arch/${MACHINE_ARCH}/include
```

## Version Management

### Version Numbering Scheme
MINIX follows a structured version numbering scheme:

```
Format: MAJOR.MINOR.PATCH-PLATFORM

Examples:
- 3.0.0          # Base release
- 3.0.1          # Patch release
- 3.1.0          # Minor release
- 3.0.0-riscv64  # Platform-specific release
- 3.0.0-i386     # x86 platform release
```

### Development Version Management
Development and release version handling:

```bash
# Development version
if [ -d .git ]; then
    # Get version from git
    VERSION=$(git describe --tags --always)
    COMMIT=$(git rev-parse HEAD)
    BRANCH=$(git rev-parse --abbrev-ref HEAD)
elif [ -f VERSION ]; then
    # Get version from file
    VERSION=$(cat VERSION)
else
    # Default version
    VERSION="3.0.0-devel"
fi
```

## Testing and Validation

### Configuration Validation
Comprehensive validation of generated configuration:

```bash
#!/bin/sh
# Configuration validation script

validate_config() {
    # Check generated headers
    if [ ! -f osrelease.h ]; then
        echo "Error: osrelease.h not generated"
        return 1
    fi
    
    # Validate version format
    if ! grep -q "OSRELEASE.*[0-9]\+\.[0-9]\+\.[0-9]\+" osrelease.h; then
        echo "Error: Invalid version format"
        return 1
    fi
    
    # Check copyright information
    if [ ! -f copyright.h ]; then
        echo "Error: copyright.h not generated"
        return 1
    fi
    
    echo "Configuration validation passed"
    return 0
}
```

### Cross-Platform Configuration Testing
Ensures configuration works across different platforms:

```bash
#!/bin/sh
# Cross-platform configuration test

test_platform_configs() {
    platforms="evbriscv64 i386 evbarm"
    
    for platform in $platforms; do
        echo "Testing configuration for $platform"
        
        # Generate platform-specific configuration
        MACHINE=$platform MACHINE_ARCH=$platform \
        sh osrelease.sh -r "3.0.0-$platform" -v "3.0-$platform" \
        > test_${platform}_osrelease.h
        
        # Validate platform-specific content
        if ! grep -q "$platform" test_${platform}_osrelease.h; then
            echo "Error: Platform $platform not in configuration"
            return 1
        fi
    done
    
    echo "All platform configurations validated"
    return 0
}
```

The kernel configuration system provides the essential foundation for managing MINIX 3 system configuration, ensuring consistent and reliable configuration across different hardware platforms and build scenarios while maintaining the flexibility needed for diverse deployment requirements.